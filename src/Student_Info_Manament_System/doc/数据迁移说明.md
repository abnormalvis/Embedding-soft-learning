# 数据迁移说明 - v1.0 到 v2.0

## 问题说明

v2.0 版本更新后，由于在 `studentAccout` 结构体中新增了 `role` 字段，导致数据结构发生变化：

### 结构变化
```c
// v1.0
typedef struct {
    char user[16];
    char password[16];
} studentAccout;  // 32 字节

// v2.0
typedef struct {
    char user[16];
    char password[16];
    UserRole role;  // 新增 4 字节
} studentAccout;  // 36 字节
```

这导致 v1.0 的数据文件无法被 v2.0 正确读取。

## 解决方案

### 方案1：重新注册（推荐）

**最简单的方法**：删除旧数据，重新注册所有账号。

```bash
# 1. 备份旧数据（可选）
cp data/students.dat data/students.dat.backup

# 2. 删除旧数据
rm data/students.dat

# 3. 运行程序重新注册
./main
```

**优点**：
- 简单直接
- 不会有兼容性问题
- 适合数据量少的情况

**缺点**：
- 需要重新输入所有数据
- 成绩信息会丢失

---

### 方案2：使用数据迁移工具

如果有大量数据需要保留，可以使用提供的迁移工具。

#### 步骤

**1. 备份并重命名旧数据**
```bash
cp data/students.dat data/students.dat.v1
```

**2. 编译迁移工具**
```bash
gcc -I include migrate_data.c -o migrate_data
```

**3. 运行迁移工具**
```bash
./migrate_data
```

**4. 验证迁移结果**
```bash
# 查看迁移后的文件大小
ls -lh data/students.dat

# 运行程序测试
./main
```

#### 迁移工具做什么

迁移工具会：
1. 读取 `data/students.dat.v1`（v1.0 格式）
2. 逐条转换数据
3. 为每个用户添加 `role = ROLE_STUDENT`
4. 写入新的 `data/students.dat`（v2.0 格式）
5. 保留旧文件作为备份

#### 输出示例
```
学生信息管理系统 - 数据迁移工具 v1.0 -> v2.0
========================================

已迁移用户：abnormalvis
已迁移用户：test1
已迁移用户：test2

========================================
迁移完成！共迁移 3 个用户账号。
旧数据文件：data/students.dat.v1（已保留）
新数据文件：data/students.dat
========================================
```

---

## 常见问题

### Q1: 为什么登录失败？
**A**: v2.0 更新后数据结构变化，旧数据无法读取。需要删除旧数据或使用迁移工具。

### Q2: 我的成绩会丢失吗？
**A**: 
- **方案1（重新注册）**: 是的，所有数据需要重新输入
- **方案2（迁移工具）**: 不会，成绩信息会被保留

### Q3: 可以回退到 v1.0 吗？
**A**: 可以，但需要：
1. 备份 v2.0 的数据文件
2. 恢复 v1.0 的程序文件
3. 恢复 v1.0 的数据文件

### Q4: 如何验证迁移成功？
**A**: 迁移后：
1. 运行 `./main`
2. 使用原来的账号密码登录
3. 如果能成功登录并看到原来的信息，说明迁移成功

### Q5: 迁移失败怎么办？
**A**: 
1. 检查 `data/students.dat.v1` 是否存在
2. 确保有文件读写权限
3. 查看错误信息
4. 如果仍失败，使用方案1重新注册

---

## 预防措施

为了避免将来再次遇到类似问题：

### 1. 定期备份数据
```bash
# 创建定期备份脚本
cp data/students.dat data/backup/students_$(date +%Y%m%d).dat
```

### 2. 版本兼容性检查
在程序中添加版本号检查：
```c
#define DATA_VERSION 2  // v2.0

// 读取时检查版本号
int version;
fread(&version, sizeof(int), 1, fp);
if (version != DATA_VERSION) {
    printf("数据文件版本不兼容，请运行迁移工具。\n");
    return FAILURE;
}
```

### 3. 使用文本格式
考虑使用 JSON 或 CSV 格式存储数据，更易于维护和迁移。

---

## 技术细节

### 结构体大小对比
```c
// v1.0
sizeof(studentInfo_v1) = 64 字节

// v2.0  
sizeof(studentInfo_v2) = 68 字节
```

### 内存布局
```
v1.0:
[studentBase: 28字节][StudentScore: 12字节][studentAccout: 32字节]

v2.0:
[studentBase: 28字节][StudentScore: 12字节][studentAccout: 36字节]
                                                            ↑
                                                        +4字节 (role)
```

---

## 建议

根据你的情况选择合适的方案：

| 情况 | 推荐方案 |
|------|---------|
| 刚开始使用，数据很少 | 方案1 - 重新注册 |
| 已有大量数据 | 方案2 - 使用迁移工具 |
| 测试环境 | 方案1 - 重新注册 |
| 生产环境 | 方案2 - 使用迁移工具 + 备份 |

---

**当前状态**: 旧数据已删除，请重新注册账号。

**下次更新**: 将提前提供迁移工具和升级说明。
