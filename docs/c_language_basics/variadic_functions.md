# 变参函数

## 基本概念
- 变参函数允许调用者传入数量可变的参数，典型代表是 `printf`。
- 需包含 `<stdarg.h>`，使用 `va_list` 保存参数状态。
- 至少要有一个固定参数，用于确定变参如何解析（数量、格式串、哨兵值等）。

## 使用流程
1. 声明形参列表以省略号 `...` 结尾。
2. 定义中声明 `va_list args;`。
3. 使用 `va_start(args, last_fixed_arg);` 初始化，`last_fixed_arg` 为最后一个固定参数。
4. 循环调用 `va_arg(args, type)` 读取参数。
5. 处理完毕后调用 `va_end(args);` 清理。

```c
int sum_ints(int count, ...) {
    int total = 0;
    va_list args;
    va_start(args, count);
    for (int i = 0; i < count; ++i) {
        total += va_arg(args, int);
    }
    va_end(args);
    return total;
}
```

## 类型与对齐
- `va_arg` 需要指定准确的类型，否则会读取错误的字节数，引发未定义行为。
- 所有 `float` 实参会提升为 `double`，`char`/`short` 会提升为 `int`。
- 结构体或数组作为参数时会退化为指针。

## 设计策略
- **格式串驱动**：类似 `printf` 的设计，通过解析格式串确定每个参数类型。
- **数量参数**：第一个参数表示后续参数数量，适合同类型数据。
- **哨兵值**：使用特殊值表示参数结束，如 `NULL` 或 `-1`。
- **变参宏**：`#define LOG(fmt, ...)` 使用 `__VA_ARGS__`，在编译期展开，常用于包装日志输出。

## 安全与替代方案
- 变参函数缺乏类型检查，编译器无法验证参数是否匹配，建议提供静态分析或封装。
- C11 引入 `_Generic` 可实现类型安全的接口选择。
- 对于复杂场景，可以改用传入数组或描述符结构体，明确参数数量与类型。

## 调试技巧
- 利用 `va_copy` 在需要多次遍历参数列表时复制一份上下文。
- 在调试器中无法直接查看变参内容，可在代码中临时打印或存储。
- 编写单元测试覆盖边界情况：零个参数、类型与数量不匹配、极端值。
